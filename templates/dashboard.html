{% extends "base.html" %}

{% block page_title %}Statistics Dashboard{% endblock %}

{% block links %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="container">
  <div class="content-wrap">
    <h2>Overall Statistics</h2>

    <div class="card-grid">
      <div class="stat-card">
        <h3>Total Users</h3>
        <p>{{ user_count }}</p>
      </div>
      <div class="stat-card">
        <h3>Total Balance</h3>
        <p>{{ "{:,.2f}".format(total_balance).replace(',', ' ') }} ₽</p>
      </div>
      <div class="stat-card">
        <h3>Total Spent (all)</h3>
        <p>{{ "{:,.2f}".format(total_spent).replace(',', ' ') }} ₽</p>
      </div>
      <div class="stat-card">
        <h3>Total Successful Payments</h3>
        <p>{{ "{:,.2f}".format(total_paid).replace(',', ' ') }} ₽</p>
      </div>
    </div>

    <h2>Spending Breakdown</h2>
    <canvas id="spendingChart"></canvas>

    <h2>Total Spending by Users (Top-10)</h2>
    <canvas id="userSpendingChart"></canvas>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/* Doughnut: successful vs other spending ---------------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  const ctx1 = document.getElementById('spendingChart').getContext('2d');
  const successful = {{ total_paid }};
  const allSpent   = {{ total_spent }};
  const otherSpent = (allSpent - successful) < 0 ? 0 : (allSpent - successful);

  new Chart(ctx1, {
    type: 'doughnut',
    data: {
      labels: ['Successful payments', 'Other spending'],
      datasets: [{ data: [successful, otherSpent] }]
    },
    options: {
      plugins: {
        tooltip: { callbacks: {
          label: c => c.formattedValue + ' ₽'
        }},
        legend: { position: 'bottom' }
      }
    }
  });

  /* Pie: total spending by users ----------------------------------------- */
  const ctx2 = document.getElementById('userSpendingChart').getContext('2d');
  const pieLabels  = {{ pie_labels|safe }};
  const pieValues  = {{ pie_values|safe }};

  new Chart(ctx2, {
    type: 'pie',
    data: {
      labels: pieLabels,
      datasets: [{ data: pieValues }]
    },
    options: {
      plugins: {
        tooltip: { callbacks: {
          label: c => c.label + ': ' + c.formattedValue + ' ₽'
        }},
        legend: { position: 'bottom' }
      }
    }
  });
});
</script>
{% endblock %}
