{% extends "base.html" %}
{% block page_title %}Statistics Dashboard{% endblock %}

{% block links %}
<link rel="stylesheet"
      href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="container"><div class="content-wrap">

  <h2>Overall Statistics</h2>

  <div class="card-grid">
    {# --- Telegram ----------------------------------------------------- #}
    <div class="stat-card"><h3>Telegram Users</h3><p>{{ tg_user_count }}</p></div>
    <div class="stat-card"><h3>TG Balance</h3>
      <p>{{ "{:,.2f}".format(tg_total_balance).replace(',', ' ') }} ₽</p></div>
    <div class="stat-card"><h3>TG Spent&nbsp;(all)</h3>
      <p>{{ "{:,.2f}".format(tg_total_spent).replace(',', ' ') }} ₽</p></div>
    <div class="stat-card"><h3>TG Successful&nbsp;Payments</h3>
      <p>{{ "{:,.2f}".format(tg_total_paid).replace(',', ' ') }} ₽</p></div>

    {# --- Web-app ------------------------------------------------------- #}
    <div class="stat-card"><h3>Web-app Users</h3><p>{{ wa_user_count }}</p></div>
    <div class="stat-card"><h3>Web-app&nbsp;Balance</h3>
      <p>{{ "{:,.2f}".format(wa_total_balance).replace(',', ' ') }} $</p></div>
    <div class="stat-card"><h3>Web-app&nbsp;Spent</h3>
      <p>{{ "{:,.2f}".format(wa_total_spent).replace(',', ' ') }} $</p></div>

    {# --- Crypto -------------------------------------------------------- #}
    <div class="stat-card"><h3>Total&nbsp;Crypto&nbsp;Received</h3>
      <p>{{ "{:,.4f}".format(crypto_received).replace(',', ' ') }} $</p></div>
  </div>

  {# ----------------------------- charts ------------------------------- #}
  <h2>Spending Breakdown (Telegram)</h2>
  <div class="chart-box"><canvas id="tgSpendingChart"></canvas></div>

  <h2>Spending Breakdown (Web-app)</h2>
  <div class="chart-box"><canvas id="waSpendingChart"></canvas></div>

  <h2>Confirmed Crypto by Network</h2>
  <div class="chart-box"><canvas id="networkChart"></canvas></div>

</div></div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {

  /* ---------- TG user spend ------------------------------------------ */
  const tgCtx   = document.getElementById('tgSpendingChart').getContext('2d');
  new Chart(tgCtx, {
    type: 'pie',
    data: { labels: {{ tg_pie_labels|safe }}, datasets: [{ data: {{ tg_pie_values|safe }} }] },
    options: { maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
  });

  /* ---------- WA user spend ------------------------------------------ */
  const waCtx   = document.getElementById('waSpendingChart').getContext('2d');
  new Chart(waCtx, {
    type: 'pie',
    data: { labels: {{ wa_pie_labels|safe }}, datasets: [{ data: {{ wa_pie_values|safe }} }] },
    options: { maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
  });

  /* ---------- Crypto by network -------------------------------------- */
  const netCtx  = document.getElementById('networkChart').getContext('2d');
  new Chart(netCtx, {
    type: 'doughnut',
    data: { labels: {{ net_labels|safe }}, datasets: [{ data: {{ net_values|safe }} }] },
    options: { maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
  });

});
</script>
{% endblock %}
